============================
Brief introduction to Mreg
============================

.. contents:: Contents
.. section-numbering::


Introduction
=============

Mreg is a system for storing information about computers in a network.
Some features include:

- building of bind compatible zone files with data such as

  - A records
  - CNAMEs
  - MX records
  - HINFO records
  - SRV records
  - automatic reverse map data = forward map with option to override
  - mx-sets makes it easier to maintain the diversity of MX records
  - etc.
- various checks to maintain data consistency
- hosts file creation
- associating comments/contact information with machines
- machine netgroups
- delegation of administrative-rights for subnets to a group of people

Mreg is built as an extensiton module to Cerebrum.  While the current
implementation is only loosely tied to the cerebrum-core schema, a
tighter integration is expected in the future.


The full version of Mreg
------------------------------

The term Mreg has been used at UoO for some time.  It referes to a
non-existing software package that can be used to keep track of some
information about computers.  Exactly what Mreg was supposed to do is
unclear; some versions were supposed to contain detailed information
about each computer, such as processor type, memory etc, while others
wanted administrative information like where the system was bought
etc.

The diversity of the information that one could want in an Mreg-like
system could result in a fairly complex piece of software that would
take a long time to develop.

The Mreg implementation described in this document only has a subset
of these features.


Limitations
---------------
Mreg does not support all records that bind supports.  DNS records not
supported by Mreg should be placed above the 'AUTOGENERATED' part of
the generated file.


The client
================

JBofh may be used to interact with mreg.  All commands are placed in
the "ip" group.  For instance, the command to allocate an IP for a new
host is "ip alloc".


Available commands
--------------------

The following commands has been implemented::

   ip         - Commands for administrating IP numbers
    a_add           host_name subnet_or_ip [force]          
                    - legg til en a-record
    a_rem           host_name [ip]                          
                    - fjern en a-record
    alloc           host_name_repeat subnet_or_ip hinfo comment contact [force]
                    - Registrerer ip-addresse for en ny maskin
    cname_add       host_name host_name [force]             
                    - registrer et cname
    comment         host_name comment                       
                    - Sette kommentar for en gitt maskin
    contact         host_name contact                       
                    - Oppgi contact for gitt maskin
    free            host_id [force]                         
                    - Sletter data for oppgitt hosnavn/ip-nr
    hinfo_list                                              
                    - list definerte hinfo
    hinfo_set       host_name hinfo                         
                    - sette hinfo
    info            host_id                                 
                    - Lister data for gitt hostnavn/ip-addresse eller cname
    list_free       subnet_or_ip                            
                    - list ledige ipnr
    mx_add          mx_set pri host_name                    
                    - legg ny entry til et MX set
    mx_del          mx_set host_name                        
                    - fjern entry fra et MX set
    mx_list                                                 
                    - list definerte MX set
    mx_set          host_name mx_set                        
                    - sette MX
    mx_show         mx_set                                  
                    - Vid definisjonen av et MX set
    rename          host_id host_id                         
                    - Forande et IP-nr/navn til et annet IP-nr/navn.
    revmap_override host_id new_host_id [force]             
                    - Registrer/slett override p? reversemap
    srv_add         service_name pri weight port host_name  
                    - Opprette en SRV record
    srv_del         service_name ttl pri weight port host_name
                    - Fjerne en SRV record
    ttl_set         host_name ttl                           
                    - Set TTL for en DNS-owner
    txt_set         host_name txt                           
                    - sette TXT

TODO::

  - maskin-nett-grupper
  - assert that we can register special data like MX-only records

When creating an ip-number and subnet_or_ip points to a subnet, the
first free IP-number in the subnet is used.  Mreg will not
automatically use IP-numbers in reserved ranges, you have to use and
explicit IP and 'force' for this.


Arguments
~~~~~~~~~~~~~~~~~~~~

The various argument types are:

  host_name 
    The name of a host (does not have to be a FQDN i.e. ending with .com.)
  host_name_repeat
    The hostname may optionally be written as pc[001..150] to allocate
    150 ip-numbers in one go.  Any leading zeroes in the first
    argument is preserved.
  host_id
    host_name of ip-number
  hinfo
    The hinfo alias.  Use 'ip list_hinfo' for legal values.
  mailserver_id
    The name of the mx_set.  Use 'ip list_mx_sets' for legal values.
  comment
    Freetext field 
  contact 
    Freetext field.  Should some time in the future be connected to a
    Cerebrum entity-id
  subnet_or_ip
    A subnet or an IP-address.  IP-adresses are indicated by giving
    them a trailing "."  When entering a non-subnet address like
    129.240.2.3, Mreg will automatically find the subnet.
  force
    Some operations require an "Y" to succeed if exsisting records has
    the same name etc.

Most query operations accept either a host_name or an ip_number for
lookup operations.  If a name is used where an IP is expected (like
"ip a_rem"), and the IP is not unique, and error message will be
shown.  (By the time you read this, a idtype:id syntax is probably
also supported)


Examples
-----------

(The hinfo_codes and mx_set names are result of automatic conversion,
and should be renamed manually)

Allocating an ip-number.  '?' may be used for help for each argument
like elsewhere in jbofh::

  jbofh >ip alloc
  Enter host name(s) >? 
  Multiple hostnames may be entered like pcusit[01..30]
  Enter host name(s) >gazonk
  Enter subnet or ip >?
  Enter subnet or ip for this operation.  IP-numbers must be marked as
  such by prepending a final dot, otherwise it will be interpreted as
  a subnet.  You may skip the 129.240 part
  Enter subnet or ip >200
  Enter HINFO code >hinfo_1  
  Enter comment >?
  Typically location
  Enter comment >test makin
  Enter contact >?
  Typically an e-mail address
  Enter contact >foo@bar.com
  name                           ip
  gazonk                         129.240.200.65

Several machines can be registered in one go::

  jbofh >ip alloc testpc[01..05] 130 hinfo_1 "fine maskiner" "foo@bar.com"
  name                           ip
  testpc01                       129.240.130.35
  testpc02                       129.240.130.39
  testpc03                       129.240.130.40
  testpc04                       129.240.130.52
  testpc05                       129.240.130.53
  jbofh >ip alloc (fin_maskin finere_maskin) 130 hinfo_1 "fine maskiner" "foo@bar.com"
  name                           ip
  fin_maskin                     129.240.130.54
  name                           ip
  finere_maskin                  129.240.130.55


Showing information about a machine::

  jbofh >ip info gazonk
  A-records              IP
    gazonk               129.240.200.65 
  Name:                  gazonk
  Hinfo:                 os=SWITCH cpu=SWITCH (code=hinfo_1)
                         contact=foo@bar.com
                         owner=test makin
  MX-set:                mx_target_1


Adding an a-record with explicit IP on an unknown subnet::

  jbofh >ip a_add barbar 127.0.0.1.
  Error: CerebrumError: Unknown subnet.  Must force
  jbofh >ip a_add barbar 127.0.0.1. Y
  OK, ip=127.0.0.1


Displaying a mx-target::

  jbofh >ip mx_show mx_target_3
  MX-set               TTL          Priority   Target
  mx_target_3          <not set>    10         smtp
  mx_target_3          <not set>    33         ulrik

Renaming a machine, either by name or IP::

  jbofh >ip rename ulrik ulrik_reborn
  OK, dns-owner ulrik renamed to ulrik_reborn
  jbofh >ip rename morgoth 129.240.201.239
  OK, ip-number morgoth renamed to 129.240.201.239

Note that all references to ulrik has been updated (because the change
was done directly in the dns-owner table)::

  jbofh >ip mx_show mx_target_4
  MX-set               TTL          Priority   Target
  mx_target_4          <not set>    10         smtp
  mx_target_4          <not set>    15         pat
  mx_target_4          <not set>    33         ulrik_reborn
  
Adding a cname::

  jbofh >ip cname_add barfoo gazonk
  OK, cname registered for gazonk

Deleting a host::

  jbofh >ip free gazonk
  Error: DNSError: A-record is used as target, or has a host_info entry
  jbofh >ip free barfoo
  OK, DNS-owner barfoo completly removed
  jbofh >ip free gazonk
  OK, DNS-owner gazonk completly removed

Somethimes the deletion must be forced::

  jbofh >ip info harell-gw
  A-records              IP
    harell-gw            129.240.209.241 
    harell-gw            129.240.230.103 
  Name:                  harell-gw
  Hinfo:                 os=IOS cpu=CISCO (code=hinfo_2)
                         contact=<not set>
                         owner=Helge Falkenberg-Arell
  MX-set:                mx_target_3
  jbofh >ip free harell-gw
  Error: CerebrumError: Multiple records would be deleted, must force
  jbofh >ip free harell-gw Y
  OK, DNS-owner harell-gw completly removed



TODO
==========

Utestående ting

Ting som må fikses før Versjon 1
-----------------------------------

- hva er reserverte ip-nr for nettmaske != 23?  (informasjon om
  lovlige subnet og deres nettmasker genereres ved å parse
  http://dager.uio.no/nett-doc/vlanibruk.txt)

- syntaxen på hosts fila som bygges må verifiseres da den er nokså
  ulik den uio har i dag.  uios fil mangler en del ip-nummer.  Bokser
  ala uio-gw7 som har multiple ip-nr er kun listet en gang.

- Forbedre testene for ulovlige data/kombinasjoner.  Flytte en del av
  testene direkte inn i DnsOwner m/venner.

- we need some support for inserting static data in the autogenerated
  part of the zone files.  Examples includes the two NS records in the
  reverse-map.

- nettgrupper:

  - trenger komandoer for å manipulere de
  - patchen til generate_nismaps.py er litt krøkkete


Ting som kan vente til Version >= 1.1:
----------------------------------------

- Mreg bør ha foreign-keys mot Cerebrum entiteter for bla. contact-info.

- rettighetshåndtering (innsnevring av rettigheter)

- legge inn en zone kolonne i dns_owner + øvrige endringer som trengs
  for å støtte multiple sonefiler.

- med såpas mange hinfo verdier som er i bruk ved uio (379), er ikke
  inntasting av kodeverdien for disse en optimal løsning.  Finnes det
  noe bedre alternativ?

